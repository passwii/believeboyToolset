# 店铺权限控制功能说明

## 功能概述

店铺导航页面现在支持基于用户权限的智能显示控制，确保用户只能看到自己有权访问的店铺信息。

## 权限规则

### 1. 管理员用户 (damonrock)
- **权限范围**：可以看到所有店铺（自有店铺 + 竞品店铺）
- **适用场景**：系统管理员需要维护和管理所有店铺信息

### 2. 普通用户（有中文名称）
- **自有店铺**：只能看到自己负责的自有店铺（按 `operator` 字段匹配中文名称）
- **竞品店铺**：只能看到自己负责的竞品店铺（按 `operator` 字段匹配中文名称）
- **示例**：尤帅用户只能看到尤帅负责的自有店铺和竞品店铺

### 3. 普通用户（无中文名称）
- **自有店铺**：无法看到任何自有店铺
- **竞品店铺**：无法看到任何竞品店铺
- **说明**：建议所有用户都设置中文名称以获得完整功能

## 实现原理

### 1. 数据库设计
- `shops` 表包含 `operator` 字段，存储店铺负责人的中文名称
- `users` 表包含 `chinese_name` 字段，存储用户的中文名称
- 通过中文名称匹配实现权限控制

### 2. 后端逻辑
在 `core/shop_model.py` 中新增：
- `get_by_user_permission()`: 根据用户权限获取店铺
- `get_shops_by_user_permission()`: 按类型分类获取店铺

在 `routes/toolset.py` 中修改：
- 获取当前用户的中文名称和权限
- 调用权限过滤方法获取对应店铺

### 3. 前端显示
在 `templates/toolset/shop_nav_embed.html` 中：
- 根据权限显示不同数量的店铺
- 提供空状态提示

## 使用方法

### 1. 设置用户中文名称
管理员可以为目标用户设置中文名称，确保与店铺负责人名称一致：

```sql
UPDATE users SET chinese_name = '尤帅' WHERE username = 'youshuai';
```

### 2. 设置店铺负责人
在添加店铺时指定负责人：

```sql
INSERT INTO shops (shop_name, operator, shop_type) 
VALUES ('尤帅的店铺', '尤帅', '自有');
```

### 3. 权限验证
用户登录后访问店铺导航页面，系统会自动根据权限显示相应店铺。

## 测试验证

运行测试脚本验证权限控制：
```bash
python test_shop_permission.py
```

测试包括：
- 尤帅用户权限测试
- 管理员权限测试  
- 无中文名用户权限测试
- 其他用户权限测试

## 扩展建议

### 1. 多角色支持
未来可扩展支持更多角色（如部门经理、运营专员等），不同角色看到不同的店铺范围。

### 2. 权限细化
可按店铺类型、品牌等进一步细分权限控制。

### 3. 批量操作
为管理员提供批量设置店铺负责人和权限的功能。

## 注意事项

1. **中文名称匹配**：权限控制基于中文名称完全匹配，确保用户中文名称与店铺负责人名称一致
2. **竞品店铺权限**：竞品店铺同样按负责人控制权限，不是所有人都能访问
3. **数据安全**：权限控制只在显示层面实现，后端仍需要防止未授权访问

## 更新日志

- 2025-10-26: 实现店铺权限控制功能
- 支持基于用户中文名称的店铺访问控制
- 管理员可查看所有店铺，普通用户只能查看相关店铺