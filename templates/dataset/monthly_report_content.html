<div class="container">
    <h1>Amazon Monthly Report 
        <br>月报（财报）</h1>
    <form id="monthly-report-form" action="{{ url_for('dataset.monthly_report') }}" method="POST" enctype="multipart/form-data">
        <label for="project_name">项目名称:</label>
        <select name="project_name" id="project_name" required>
            <option value="">请选择项目</option>
            {% for project in projects %}
            <option value="{{ project }}">{{ project }}</option>
            {% endfor %}
        </select>
        

        <label for="report_date">报表日期:</label>
        <select name="report_date" id="report_date" required>
            <option value="">请选择日期</option>
            <option value="2025-07">2025-07</option>
            <option value="2025-08">2025-08</option>
            <option value="2025-09">2025-09</option>
            <option value="2025-10">2025-10</option>
            <option value="2025-11">2025-11</option>
            <option value="2025-12">2025-12</option>
            <option value="2026-01">2026-01</option>
            <option value="2026-02">2026-02</option>
            <option value="2026-03">2026-03</option>
            
        </select>

        <label for="payment_range_report">付款报告:
            <a href="{{ url_for('help.payment_report') }}" target="_blank" class="help-icon">?</a>
        </label>
        <input type="file" name="payment_range_report" accept=".csv" required>

        <button type="submit">生成月报</button>
    </form>
</div>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // 表单提交事件
        const form = document.getElementById('monthly-report-form');
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            
            // 创建FormData对象
            const formData = new FormData(this);
            
            // 显示加载指示器
            const formContainer = this.parentElement;
            const originalContent = formContainer.innerHTML;
            formContainer.innerHTML = `
                <div class="loading-indicator">
                    <i class="fas fa-spinner fa-spin"></i>
                    <span>正在生成月报，请稍候...</span>
                </div>
            `;
            
            // 发送AJAX请求
            fetch(this.action, {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (response.ok) {
                    return response.blob();
                } else {
                    throw new Error('生成月报失败');
                }
            })
            .then(blob => {
                // 创建下载链接
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'monthly_report.xlsx';
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
                
                // 恢复表单
                formContainer.innerHTML = originalContent;
                
                // 重新初始化事件监听器
                const newForm = document.getElementById('monthly-report-form');
                
                if (newForm) {
                    newForm.addEventListener('submit', arguments.callee);
                }
                
                // 显示成功消息
                showNotification('月报生成成功', 'success');
            })
            .catch(error => {
                console.error('Error:', error);
                formContainer.innerHTML = originalContent;
                
                // 重新初始化事件监听器
                const newForm = document.getElementById('monthly-report-form');
                
                if (newForm) {
                    newForm.addEventListener('submit', arguments.callee);
                }
                
                // 显示错误消息
                showNotification('生成月报失败，请重试', 'error');
            });
        });
    });
    
    // 通知函数
    function showNotification(message, type = 'info') {
        const notification = document.createElement('div');
        notification.className = `cyber-notification ${type}`;
        notification.innerHTML = `
            <div class="notification-content">
                <i class="fas ${getNotificationIcon(type)}"></i>
                <span>${message}</span>
            </div>
            <div class="notification-progress"></div>
        `;
        
        // 添加样式
        notification.style.cssText = `
            position: fixed;
            top: 90px;
            right: 20px;
            background: rgba(10, 10, 10, 0.9);
            backdrop-filter: blur(10px);
            border: 1px solid ${getNotificationColor(type)};
            border-radius: 10px;
            padding: 15px 20px;
            color: white;
            font-weight: 500;
            z-index: 10000;
            min-width: 250px;
            box-shadow: 0 0 20px ${getNotificationColor(type)}40;
            transform: translateX(400px);
            transition: transform 0.3s ease;
        `;
        
        document.body.appendChild(notification);
        
        // 滑入动画
        setTimeout(() => {
            notification.style.transform = 'translateX(0)';
        }, 10);
        
        // 进度条动画
        const progressBar = notification.querySelector('.notification-progress');
        progressBar.style.cssText = `
            position: absolute;
            bottom: 0;
            left: 0;
            height: 3px;
            background: ${getNotificationColor(type)};
            width: 100%;
            transform-origin: left;
            animation: progressAnimation 3s linear forwards;
        `;
        
        // 添加进度条动画
        const style = document.createElement('style');
        style.textContent = `
            @keyframes progressAnimation {
                from { transform: scaleX(1); }
                to { transform: scaleX(0); }
            }
        `;
        document.head.appendChild(style);
        
        // 3秒后自动移除
        setTimeout(() => {
            notification.style.transform = 'translateX(400px)';
            setTimeout(() => {
                if (notification.parentNode) {
                    document.body.removeChild(notification);
                }
                if (style.parentNode) {
                    document.head.removeChild(style);
                }
            }, 300);
        }, 3000);
    }
    
    function getNotificationIcon(type) {
        switch(type) {
            case 'success': return 'fa-check-circle';
            case 'warning': return 'fa-exclamation-triangle';
            case 'error': return 'fa-times-circle';
            default: return 'fa-info-circle';
        }
    }
    
    function getNotificationColor(type) {
        switch(type) {
            case 'success': return '#00ff88';
            case 'warning': return '#ffaa00';
            case 'error': return '#ff006e';
            default: return '#00d4ff';
        }
    }
</script>