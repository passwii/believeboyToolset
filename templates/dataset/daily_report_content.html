<div class="container">
    <h1>Amazon Sales Report <br>日/周报</h1>
    <form id="daily-report-form" action="{{ url_for('dataset.daily_report') }}" method="POST" enctype="multipart/form-data">
        <label for="project_name">项目名称:</label>
        <select name="project_name" id="project_name" required>
            <option value="">请选择项目</option>
            {% for project in projects %}
            <option value="{{ project }}">{{ project }}</option>
            {% endfor %}
        </select>
        

        <label for="report_date">报表日期:</label>
        <div class="date-container">
            <input type="date" name="report_date" id="report_date" required>
            <button type="button" id="yesterday-btn">昨天</button>
        </div>

        <label for="sales_report">所有订单:
            <a href="{{ url_for('help.orders_report_help') }}" target="_blank" class="help-icon">?</a>
        </label>
        <input type="file" name="sales_report" accept=".txt" required>
        <label for="ad_report">广告报表:
            <a href="{{ url_for('help.ad_product_report') }}" target="_blank" class="help-icon">?</a>
        </label>
        <input type="file" name="ad_report" accept=".xlsx" required>

        <label for="fba_report">FBA库存:
            <a href="{{ url_for('help.fba_inventory_help') }}" target="_blank" class="help-icon">?</a>
        </label>
        <input type="file" name="fba_report" accept=".txt" required>

        <button type="submit">生成日报</button>
    </form>
</div>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // 昨天按钮点击事件
        const yesterdayBtn = document.getElementById('yesterday-btn');
        yesterdayBtn.addEventListener('click', function() {
            // 获取昨天的日期
            const yesterday = new Date();
            yesterday.setDate(yesterday.getDate() - 1);
            
            // 设置日期输入框的值
            document.getElementById('report_date').value = yesterday.toISOString().split('T')[0];
        });
        
        // 表单提交事件
        const form = document.getElementById('daily-report-form');
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            
            // 创建FormData对象
            const formData = new FormData(this);
            
            // 显示加载指示器
            const formContainer = this.parentElement;
            const originalContent = formContainer.innerHTML;
            formContainer.innerHTML = `
                <div class="loading-indicator">
                    <i class="fas fa-spinner fa-spin"></i>
                    <span>正在生成日报，请稍候...</span>
                </div>
            `;
            
            // 发送AJAX请求
            fetch(this.action, {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (response.ok) {
                    return response.blob();
                } else {
                    throw new Error('生成日报失败');
                }
            })
            .then(blob => {
                // 创建下载链接
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'daily_report.xlsx';
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
                
                // 恢复表单
                formContainer.innerHTML = originalContent;
                
                // 重新初始化事件监听器
                const newYesterdayBtn = document.getElementById('yesterday-btn');
                const newForm = document.getElementById('daily-report-form');
                
                if (newYesterdayBtn) {
                    newYesterdayBtn.addEventListener('click', function() {
                        const yesterday = new Date();
                        yesterday.setDate(yesterday.getDate() - 1);
                        document.getElementById('report_date').value = yesterday.toISOString().split('T')[0];
                    });
                }
                
                if (newForm) {
                    newForm.addEventListener('submit', arguments.callee);
                }
                
                // 显示成功消息
                showNotification('日报生成成功', 'success');
            })
            .catch(error => {
                console.error('Error:', error);
                formContainer.innerHTML = originalContent;
                
                // 重新初始化事件监听器
                const newYesterdayBtn = document.getElementById('yesterday-btn');
                const newForm = document.getElementById('daily-report-form');
                
                if (newYesterdayBtn) {
                    newYesterdayBtn.addEventListener('click', function() {
                        const yesterday = new Date();
                        yesterday.setDate(yesterday.getDate() - 1);
                        document.getElementById('report_date').value = yesterday.toISOString().split('T')[0];
                    });
                }
                
                if (newForm) {
                    newForm.addEventListener('submit', arguments.callee);
                }
                
                // 显示错误消息
                showNotification('生成日报失败，请重试', 'error');
            });
        });
    });
    
    // 通知函数
    function showNotification(message, type = 'info') {
        const notification = document.createElement('div');
        notification.className = `cyber-notification ${type}`;
        notification.innerHTML = `
            <div class="notification-content">
                <i class="fas ${getNotificationIcon(type)}"></i>
                <span>${message}</span>
            </div>
            <div class="notification-progress"></div>
        `;
        
        // 添加样式
        notification.style.cssText = `
            position: fixed;
            top: 90px;
            right: 20px;
            background: rgba(10, 10, 10, 0.9);
            backdrop-filter: blur(10px);
            border: 1px solid ${getNotificationColor(type)};
            border-radius: 10px;
            padding: 15px 20px;
            color: white;
            font-weight: 500;
            z-index: 10000;
            min-width: 250px;
            box-shadow: 0 0 20px ${getNotificationColor(type)}40;
            transform: translateX(400px);
            transition: transform 0.3s ease;
        `;
        
        document.body.appendChild(notification);
        
        // 滑入动画
        setTimeout(() => {
            notification.style.transform = 'translateX(0)';
        }, 10);
        
        // 进度条动画
        const progressBar = notification.querySelector('.notification-progress');
        progressBar.style.cssText = `
            position: absolute;
            bottom: 0;
            left: 0;
            height: 3px;
            background: ${getNotificationColor(type)};
            width: 100%;
            transform-origin: left;
            animation: progressAnimation 3s linear forwards;
        `;
        
        // 添加进度条动画
        const style = document.createElement('style');
        style.textContent = `
            @keyframes progressAnimation {
                from { transform: scaleX(1); }
                to { transform: scaleX(0); }
            }
        `;
        document.head.appendChild(style);
        
        // 3秒后自动移除
        setTimeout(() => {
            notification.style.transform = 'translateX(400px)';
            setTimeout(() => {
                if (notification.parentNode) {
                    document.body.removeChild(notification);
                }
                if (style.parentNode) {
                    document.head.removeChild(style);
                }
            }, 300);
        }, 3000);
    }
    
    function getNotificationIcon(type) {
        switch(type) {
            case 'success': return 'fa-check-circle';
            case 'warning': return 'fa-exclamation-triangle';
            case 'error': return 'fa-times-circle';
            default: return 'fa-info-circle';
        }
    }
    
    function getNotificationColor(type) {
        switch(type) {
            case 'success': return '#00ff88';
            case 'warning': return '#ffaa00';
            case 'error': return '#ff006e';
            default: return '#00d4ff';
        }
    }
</script>