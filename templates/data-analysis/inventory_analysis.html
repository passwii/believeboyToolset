<div class="container">
    <h1>Amazon FBA 库存分析</h1>
    
    <!-- 上传区域 -->
    <div class="upload-section">
        <div class="drop-area" id="drop-area">
            <h3>拖拽库存CSV文件到此处</h3>
            <p>或点击选择亚马逊FBA库存快照CSV文件</p>
            <p class="file-types">支持: .csv (如 Maywoqi-INV.csv)</p>
            <input type="file" id="file-input" name="file" accept=".csv" style="display: none;">
        </div>
        
        <button type="button" id="analyze-btn" class="analyze-btn" disabled>开始分析</button>
    </div>
    
    <!-- 结果区域 -->
    <div class="results-section" id="results-section" style="display: none;">
        <!-- 关键指标卡片 -->
        <div class="metrics-grid">
            <div class="metric-card">
                <h3 id="total-available">0</h3>
                <p>总可用库存</p>
            </div>
            <div class="metric-card">
                <h3 id="total-skus">0</h3>
                <p>SKU总数</p>
            </div>
            <div class="metric-card">
                <h3 id="total-storage-cost">$0</h3>
                <p>下月存储费</p>
            </div>
            <div class="metric-card">
                <h3 id="total-old-inv">0</h3>
                <p>老库存总量</p>
            </div>
        </div>
        
        <!-- 图表区域 -->
        <div class="charts-grid">
            <div class="chart-container">
                <h4>库存健康分布</h4>
                <div id="health-chart"></div>
            </div>
            <div class="chart-container">
                <h4>销售趋势 (单位发货)</h4>
                <div id="sales-trend-chart"></div>
            </div>
            <div class="chart-container">
                <h4>推荐行动</h4>
                <div id="rec-action-chart"></div>
            </div>
        </div>
        
        <!-- Top风险SKU表格 -->
        <div class="table-container">
            <h4>Top 5 高风险SKU (老库存)</h4>
            <table id="risk-skus-table">
                <thead>
                    <tr>
                        <th>SKU</th>
                        <th>老库存量</th>
                        <th>可用库存</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
</div>

<!-- Plotly CDN -->
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>

<style>
.container { max-width: 1200px; margin: 0 auto; padding: 20px; }
h1 { text-align: center; color: var(--text-primary); margin-bottom: 30px; }
.upload-section { text-align: center; margin-bottom: 40px; }
.drop-area {
    border: 2px dashed rgba(0, 212, 255, 0.3); border-radius: 12px; padding: 40px;
    background: rgba(255,255,255,0.05); transition: all 0.3s; cursor: pointer;
}
.drop-area:hover, .drop-area.dragover { border-color: var(--neon-blue); background: rgba(0,212,255,0.1); }
.drop-area.completed { border-color: var(--success-color); background: rgba(0,255,136,0.1); }
.analyze-btn {
    background: linear-gradient(45deg, var(--neon-blue), #00d4ff); color: white; border: none;
    padding: 15px 40px; border-radius: 25px; font-size: 16px; cursor: pointer; margin-top: 20px;
    transition: all 0.3s; min-width: 150px;
}
.analyze-btn:hover:not(:disabled) { transform: scale(1.05); box-shadow: 0 10px 20px rgba(0,212,255,0.3); }
.analyze-btn:disabled { opacity: 0.5; cursor: not-allowed; }
.results-section { animation: fadeIn 0.5s; }
@keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
.metrics-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 40px; }
.metric-card {
    background: rgba(255,255,255,0.1); border-radius: 12px; padding: 20px; text-align: center;
    border: 1px solid rgba(255,255,255,0.2); backdrop-filter: blur(10px);
}
.metric-card h3 { font-size: 2em; color: var(--neon-blue); margin: 0 0 5px; }
.metric-card p { color: var(--text-secondary); margin: 0; }
.charts-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 30px; margin-bottom: 40px; }
.chart-container { background: rgba(255,255,255,0.05); border-radius: 12px; padding: 20px; }
.chart-container h4 { margin-top: 0; color: var(--text-primary); }
#health-chart, #sales-trend-chart, #rec-action-chart { height: 400px; width: 100%; }
.table-container { background: rgba(255,255,255,0.05); border-radius: 12px; padding: 20px; overflow-x: auto; }
table { width: 100%; border-collapse: collapse; color: var(--text-primary); }
th, td { padding: 12px; text-align: left; border-bottom: 1px solid rgba(255,255,255,0.1); }
th { background: rgba(0,212,255,0.1); font-weight: 600; }
tr:hover { background: rgba(0,212,255,0.05); }
.loading { text-align: center; padding: 40px; color: var(--text-secondary); }
.error { color: var(--error-color); background: rgba(255,0,110,0.1); padding: 20px; border-radius: 8px; margin: 20px 0; }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const dropArea = document.getElementById('drop-area');
    const fileInput = document.getElementById('file-input');
    const analyzeBtn = document.getElementById('analyze-btn');
    const resultsSection = document.getElementById('results-section');

    let selectedFile = null;

    // 拖拽事件
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        dropArea.addEventListener(eventName, preventDefaults, false);
    });
    function preventDefaults(e) { e.preventDefault(); e.stopPropagation(); }

    ['dragenter', 'dragover'].forEach(eventName => {
        dropArea.addEventListener(eventName, () => dropArea.classList.add('dragover'), false);
    });
    ['dragleave', 'drop'].forEach(eventName => {
        dropArea.addEventListener(eventName, () => dropArea.classList.remove('dragover'), false);
    });

    dropArea.addEventListener('drop', handleDrop, false);
    dropArea.addEventListener('click', () => fileInput.click());
    fileInput.addEventListener('change', handleFileSelect);

    function handleDrop(e) {
        const files = e.dataTransfer.files;
        if (files.length > 0) {
            selectedFile = files[0];
            updateUI();
        }
    }

    function handleFileSelect(e) {
        selectedFile = e.target.files[0];
        updateUI();
    }

    function updateUI() {
        if (selectedFile) {
            dropArea.textContent = `已选择: ${selectedFile.name}`;
            dropArea.classList.add('completed');
            analyzeBtn.disabled = false;
        }
    }

    // 分析按钮
    analyzeBtn.addEventListener('click', async () => {
        if (!selectedFile) return;

        const formData = new FormData();
        formData.append('file', selectedFile);

        analyzeBtn.textContent = '分析中...';
        analyzeBtn.disabled = true;
        resultsSection.style.display = 'none';

        try {
            const response = await fetch('/data-analysis/analyze', {
                method: 'POST',
                body: formData
            });
            const result = await response.json();

            if (result.success) {
                renderResults(result.data);
                resultsSection.style.display = 'block';
            } else {
                showError(result.error);
            }
        } catch (err) {
            showError('网络错误: ' + err.message);
        } finally {
            analyzeBtn.textContent = '开始分析';
            analyzeBtn.disabled = false;
        }
    });

    function renderResults(data) {
        // 指标卡片
        document.getElementById('total-available').textContent = data.totals.total_available.toLocaleString();
        document.getElementById('total-skus').textContent = data.totals.total_skus;
        document.getElementById('total-storage-cost').textContent = '$' + data.total_storage_cost.toFixed(2);
        document.getElementById('total-old-inv').textContent = data.total_old_inventory.toLocaleString();

        // 健康分布饼图
        const healthLabels = Object.keys(data.health_summary || {});
        const healthValues = Object.values(data.health_summary || {}).map(v => v.total_available);
        Plotly.newPlot('health-chart', [{
            values: healthValues,
            labels: healthLabels,
            type: 'pie',
            hole: 0.4,
            textinfo: 'label+percent'
        }], { title: { text: '', font: { size: 14 } } });

        // 销售趋势条形图
        const salesTrend = data.sales_trend;
        Plotly.newPlot('sales-trend-chart', [{
            x: Object.keys(salesTrend),
            y: Object.values(salesTrend),
            type: 'bar',
            marker: { color: 'rgba(0,212,255,0.8)' }
        }], { title: { text: '', font: { size: 14 } }, yaxis: { title: '发货量' } });

        // 推荐行动条形图
        const recActions = data.recommended_actions;
        Plotly.newPlot('rec-action-chart', [{
            x: Object.keys(recActions),
            y: Object.values(recActions),
            type: 'bar',
            marker: { color: 'rgba(255,170,0,0.8)' }
        }], { title: { text: '', font: { size: 14 } }, yaxis: { title: 'SKU数量' } });

        // Top风险SKU表格
        const tbody = document.querySelector('#risk-skus-table tbody');
        tbody.innerHTML = '';
        (data.top_risk_skus || []).forEach(sku => {
            const row = tbody.insertRow();
            row.innerHTML = `<td>${sku.sku}</td><td>${sku.total_old_age.toLocaleString()}</td><td>${sku.available.toLocaleString()}</td>`;
        });
    }

    function showError(msg) {
        const errorDiv = document.createElement('div');
        errorDiv.className = 'error';
        errorDiv.textContent = '分析失败: ' + msg;
        document.querySelector('.upload-section').appendChild(errorDiv);
        setTimeout(() => errorDiv.remove(), 5000);
    }
});
</script>